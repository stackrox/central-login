name: E2E

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    - cron: '0 5 * * 0'

env:
  ROX_URL: 'https://127.0.0.1:8000'

jobs:
  e2e:
    name: E2E
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for the central-login action which we will test.
    steps:
      - uses: actions/checkout@v4
      
      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
      
      - uses: actions/checkout@v4
        with:
          repository: stackrox/stackrox
          path: stackrox
      
      - name: Install Stackrox
        env:
          MAIN_IMAGE_TAG: "latest"
          SENSOR_HELM_DEPLOY: "true"
          ROX_SCANNER_V4: "false"
        run: |
          stackrox/deploy/k8s/deploy-local.sh
          ROX_PASSWORD=$(cat stackrox/deploy/k8s/central-deploy/password)
          echo "::add-mask::$ROX_PASSWORD"
          echo "ROX_PASSWORD=$ROX_PASSWORD" >> $GITHUB_ENV

      - name: Add machine to machine configuration in Central
        run: |
          curl -u admin:${ROX_PASSWORD} \
          ${ROX_URL}/v1/auth/m2m \
          -k -d '{"config": {"type": "GITHUB_ACTIONS", "tokenExpirationDuration": "5m", "mappings":[{"key":"sub","valueExpression":"repo:stackrox/central-login.*", "role":"Analyst"}]}}'

      - name: Run central-login action
        uses: ./
        with:
          endpoint: ${{ env.ROX_URL }}
          skip-tls-verify: true

      - name: Install roxctl
        uses: stackrox/roxctl-installer-action@v1
        with:
          central-endpoint: ${{ env.ROX_URL }}
          central-token: ${{ env.ROX_API_TOKEN }}
          skip-tls-verify: true

      - name: Check the current user with roxctl
        run: >
          roxctl central cert --output ca.pem
          roxctl central whoami --ca ca.pem
